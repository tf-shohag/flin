version: '3.8'

services:
  # Node 1 - Raft Leader (initial)
  flin-node-1:
    build:
      context: ../..
      dockerfile: Dockerfile
    container_name: flin-node-1
    hostname: flin-node-1
    ports:
      - "6380:6380"  # TCP KV port
      - "8080:8080"  # HTTP management port
      - "9080:9080"  # Raft port
    environment:
      - NODE_ID=node-1
      - KV_PORT=6380
      - HTTP_PORT=8080
      - RAFT_PORT=9080
      - RAFT_DIR=/data/raft
      - PARTITION_COUNT=64
    volumes:
      - flin-node-1-data:/data
    networks:
      - flin-cluster
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Node 2
  flin-node-2:
    build:
      context: ../..
      dockerfile: Dockerfile
    container_name: flin-node-2
    hostname: flin-node-2
    ports:
      - "6381:6380"
      - "8081:8080"
      - "9081:9080"
    environment:
      - NODE_ID=node-2
      - KV_PORT=6380
      - HTTP_PORT=8080
      - RAFT_PORT=9080
      - RAFT_DIR=/data/raft
      - JOIN_ADDR=flin-node-1:8080
    volumes:
      - flin-node-2-data:/data
    networks:
      - flin-cluster
    depends_on:
      - flin-node-1
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Node 3
  flin-node-3:
    build:
      context: ../..
      dockerfile: Dockerfile
    container_name: flin-node-3
    hostname: flin-node-3
    ports:
      - "6382:6380"
      - "8082:8080"
      - "9082:9080"
    environment:
      - NODE_ID=node-3
      - KV_PORT=6380
      - HTTP_PORT=8080
      - RAFT_PORT=9080
      - RAFT_DIR=/data/raft
      - JOIN_ADDR=flin-node-1:8080
    volumes:
      - flin-node-3-data:/data
    networks:
      - flin-cluster
    depends_on:
      - flin-node-1
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3

networks:
  flin-cluster:
    driver: bridge

volumes:
  flin-node-1-data:
  flin-node-2-data:
  flin-node-3-data:
